#!/bin/bash

currentSpace=$(yabai -m query --windows --window | jq -re "." | jq -re ".space")
spaces=($(yabai -m query --spaces | jq -re ".[] | select(.windows | length > 0)" | jq -re ".index"))

for i in "${!spaces[@]}"; do
  if [[ "${spaces[$i]}" = "${currentSpace}" ]]; then
    currentIndex=$i
    break
  fi
done

numSpaces=${#spaces[@]}

nextIndex=0
if [[ $1 =~ ^(next|prev)$ ]]; then
  if [[ $1 == "next" ]]; then
    nextIndex=$(($(($currentIndex + 1)) % $numSpaces))
  elif [[ $1 == "prev" ]]; then
    nextIndex=$(($(($currentIndex - 1 + $numSpaces)) % $numSpaces))
  fi
  nextSpace=${spaces[$nextIndex]}
elif [[ " ${spaces[*]} " =~ " $1 " ]]; then
  nextSpace=$1
else
  exit 0
fi

windowOnSpace=$(yabai -m query --spaces --space ${nextSpace} | jq -re '.["windows"][0]')
if [[ "$windowOnSpace" -ne "0" ]]; then
    yabai -m window --focus "$windowOnSpace"
fi

